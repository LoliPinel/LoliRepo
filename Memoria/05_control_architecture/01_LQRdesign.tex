\section{Feedback in state space. The Linear Quadratic Regulator}

The quadratic optimal control method is one of the control methods applied in state space systems and it provides a systematic way of computing the state feedback control gain matrix \cite{Ogata}.
Given the state space system equation
\begin{equation}
\dot{x} = Ax+Bu ,
\label{eq:sseq}
\end{equation}
the LQR determines the matrix $K$ of the optima control vector
\begin{equation}
u(t) = -Kx(t)
\label{eq:control}
\end{equation}
so as to minimize the performance index
\begin{equation}
J = \int_{0}^{\infty}(x^{T}Qx+u^{T}Ru) dt
\end{equation}

where $Q$ is a positive-definite (or positive-semidefinite) Hermitian or real symmetric matrix and $R$ is a positive-definite Hermitian or real symmetric matrix. Note that the matrices $Q$ and $R$ determine the relative importance of the error and the expenditure of the energy of the control signals.
The linear control law given by equation \ref{eq:control} is the optimal control law. Therefore, if the unknown elements of the matrix $K = [K_1 \quad K_2]$ are determined so as to minimize the performance index, then $u(t) = -Kx$  is optimal for any initial state $x(0)$. The block diagram showing the optimal configuration for the single inverted pendulum system is presented in Figure \ref{fig:block_diagram}. The controller maintain desired ($x_{ZMP}$) position of the single pendulum close to zero. Thus, the reference input of the control system in Figure [REF] is not zero.?????
\begin{figure}[!hbt]
\centering
\includegraphics[scale=0.4]{diagrama.pdf}
\caption{Block diagram}
\label{fig:block_diagram}
\end{figure}

The state space representation \ref{eq:state_space}, \ref{eq:state_space_out} is a controllable canonical form that is important for the LQR controller design. It is desired to keep the actual ZMP, measured and computed by force-torque sensors located in the feet of the humanoid robot, close to its stable reference position as was discussed in previous sections. As the system is a type 0 plant, it is necessary to insert an integrator in order to design a ZMP servo control system (type 1) and remove the steady state error. Therefore, we feed the output signal $y$ (which indicates the real ZMP) back to the input and an integrator in the feedforward path as is shown in Figure \ref{fig:diagrama_int}.

\begin{figure}[!hbt]
\centering
\includegraphics[scale=0.4]{diagrama_int.pdf}
\caption{ZMP LQR control system.}
\label{fig:diagrama_int}
\end{figure}

Thus, referring equations \ref{eq:state_space} and \ref{eq:state_space_out} and Figure \ref{fig:diagrama_int} and considering the actual ZMP position as the output of the system and $r$ as the reference input signal we obtain the equations for the closed loop system as follows:
\begin{equation}
\dot{x} = \textbf{A}\textbf{x} + \textbf{B}u
\end{equation}

\begin{equation}
y = \textbf{C}\textbf{x} + \textbf{D}u
\end{equation}

\begin{equation}
u = - \textbf{K}\textbf{x} + K_i z
\end{equation}

\begin{equation}
\dot{z} = r - y = r - (\textbf{C}\textbf{x} + \textbf{D}u)
\end{equation}

For the type 1 servo system, the state error equation is given by:
\begin{equation}
\begin{bmatrix}
\dot{\textbf{x}}\\
\dot{z}
\end{bmatrix} = 
\begin{bmatrix}
\textbf{A} & \textbf{0}\\
\textbf{-C} & 0
\end{bmatrix}
\begin{bmatrix}
\textbf{x}\\
z
\end{bmatrix} + 
\begin{bmatrix}
\textbf{B}\\
0
\end{bmatrix}
u
\end{equation}
and the control signal $u$ is given by:
\begin{equation}
u = \begin{bmatrix}
-\textbf{K} & K_i
\end{bmatrix}
\begin{bmatrix}
\textbf{x}\\
z
\end{bmatrix}
\end{equation}

The optimum $K$ matrix is obtained from equations \ref{eq:Kcont} and \ref{eq:Kdisc}.
\begin{equation}
K = R^{-1}B^{T}P \quad (continuous \quad case)
\label{eq:Kcont}
\end{equation}
\begin{equation}
K = (R + B^{T}PB)^{-1}B^{T}PA \quad (discrete \quad case)
\label{eq:Kdisc}
\end{equation}

where $P$ is a positive-definite Hermitian or real symmetric matrix and it is necessary to compute the algebraic Ricatti Equation
\begin{equation}
P \rightarrow A^{T}P+PA-PBR^{-1}B^{T}P+Q = 0 \quad (continuous \quad case)
\end{equation}
\begin{equation}
P \rightarrow A^{T}PA+P-A^{T}PB(R+B^{T}PB)^{-1}B^{T}PA+Q = 0 \quad (discrete \quad case)
\end{equation}


In order to obtain the controller design for further simulations and experiments, the following mechanical parameters of the inverted pendulum (corresponding to Rh-2 humanoid robot) were taken: $m$ = 62.416 kg, $l$=1.03 m, $k$=0.1. \textcolor{red}{Valor y unidades de stiffness???}. For the optimum response of the control system, it is suggested to take $Q = C^{T}C = \begin{bmatrix}
5.037 \cdot 10^{-8} & 0\\
0 & 0
\end{bmatrix}$ and $R = 1 $. 
%%% AÃ‘ADIR SOLO SI SE PRUEBA QUE ES MAS RAPIDO %%%%
%But for a faster response of the control, we take $Q = C^{T}C = \begin{bmatrix}
%1000 & 0\\
%0 & 0
%\end{bmatrix}$.  
After the LQR controller was designed, the control gains matrix $K = [18.89 \quad 6.14]$ was obtained using a sample time $T = 0.001$ s.











